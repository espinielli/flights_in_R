<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 7 Loops and SID data | Analysing Flights with R - UNDER CONSTRUCTION</title>
  <meta name="description" content="This is a training and reference manual for Eurocontrol staff, on how to use RStudio to analyse our traffic data. - UNDER CONSTRUCTION -" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 7 Loops and SID data | Analysing Flights with R - UNDER CONSTRUCTION" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a training and reference manual for Eurocontrol staff, on how to use RStudio to analyse our traffic data. - UNDER CONSTRUCTION -" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 7 Loops and SID data | Analysing Flights with R - UNDER CONSTRUCTION" />
  
  <meta name="twitter:description" content="This is a training and reference manual for Eurocontrol staff, on how to use RStudio to analyse our traffic data. - UNDER CONSTRUCTION -" />
  

<meta name="author" content="David Marsh" />


<meta name="date" content="2021-03-24" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="references.html"/>
<link rel="next" href="splitparse.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Analysing Flights in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> How to use this book</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#before-you-start"><i class="fa fa-check"></i><b>1.1</b> Before you start</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#ways-to-use-the-material"><i class="fa fa-check"></i><b>1.2</b> Ways to Use the Material</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#structure-of-the-book"><i class="fa fa-check"></i><b>1.3</b> Structure of the book</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#whats-gone-wrong"><i class="fa fa-check"></i><b>1.4</b> What’s gone wrong?</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="start.html"><a href="start.html"><i class="fa fa-check"></i><b>2</b> Getting started</a>
<ul>
<li class="chapter" data-level="2.1" data-path="start.html"><a href="start.html#rstudio"><i class="fa fa-check"></i><b>2.1</b> Orientation in RStudio</a></li>
<li class="chapter" data-level="2.2" data-path="start.html"><a href="start.html#first-project"><i class="fa fa-check"></i><b>2.2</b> First project</a></li>
<li class="chapter" data-level="2.3" data-path="start.html"><a href="start.html#first-code"><i class="fa fa-check"></i><b>2.3</b> First code</a></li>
<li class="chapter" data-level="2.4" data-path="start.html"><a href="start.html#packages"><i class="fa fa-check"></i><b>2.4</b> First packages</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="start.html"><a href="start.html#twocolons"><i class="fa fa-check"></i><b>2.4.1</b> Package basics</a></li>
<li class="chapter" data-level="2.4.2" data-path="start.html"><a href="start.html#tidyverse"><i class="fa fa-check"></i><b>2.4.2</b> Tidyverse</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="start.html"><a href="start.html#filetypes"><i class="fa fa-check"></i><b>2.5</b> File types</a></li>
<li class="chapter" data-level="2.6" data-path="start.html"><a href="start.html#whats-gone-wrong-1"><i class="fa fa-check"></i><b>2.6</b> What’s gone wrong?</a></li>
<li class="chapter" data-level="2.7" data-path="start.html"><a href="start.html#test-yourself"><i class="fa fa-check"></i><b>2.7</b> Test yourself</a>
<ul>
<li class="chapter" data-level="2.7.1" data-path="start.html"><a href="start.html#questions"><i class="fa fa-check"></i><b>2.7.1</b> Questions</a></li>
<li class="chapter" data-level="2.7.2" data-path="start.html"><a href="start.html#answers"><i class="fa fa-check"></i><b>2.7.2</b> Answers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="firstLook.html"><a href="firstLook.html"><i class="fa fa-check"></i><b>3</b> First look at data and CO<sub>2</sub> emissions</a>
<ul>
<li class="chapter" data-level="3.1" data-path="firstLook.html"><a href="firstLook.html#loadco2"><i class="fa fa-check"></i><b>3.1</b> Looking at data: CO<sub>2</sub> Data</a></li>
<li class="chapter" data-level="3.2" data-path="firstLook.html"><a href="firstLook.html#extractfield"><i class="fa fa-check"></i><b>3.2</b> Extracting variables</a></li>
<li class="chapter" data-level="3.3" data-path="firstLook.html"><a href="firstLook.html#someValues"><i class="fa fa-check"></i><b>3.3</b> Extracting a few values</a></li>
<li class="chapter" data-level="3.4" data-path="firstLook.html"><a href="firstLook.html#co2-scatter-plot"><i class="fa fa-check"></i><b>3.4</b> CO<sub>2</sub> Scatter plot</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="firstLook.html"><a href="firstLook.html#first-draft"><i class="fa fa-check"></i><b>3.4.1</b> First draft</a></li>
<li class="chapter" data-level="3.4.2" data-path="firstLook.html"><a href="firstLook.html#improve-the-titles"><i class="fa fa-check"></i><b>3.4.2</b> Improve the titles</a></li>
<li class="chapter" data-level="3.4.3" data-path="firstLook.html"><a href="firstLook.html#statecluster"><i class="fa fa-check"></i><b>3.4.3</b> and with clustering by state</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="firstLook.html"><a href="firstLook.html#whats-gone-wrong-2"><i class="fa fa-check"></i><b>3.5</b> What’s gone wrong?</a></li>
<li class="chapter" data-level="3.6" data-path="firstLook.html"><a href="firstLook.html#test-yourself-1"><i class="fa fa-check"></i><b>3.6</b> Test yourself</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="firstLook.html"><a href="firstLook.html#questions-1"><i class="fa fa-check"></i><b>3.6.1</b> Questions</a></li>
<li class="chapter" data-level="3.6.2" data-path="firstLook.html"><a href="firstLook.html#answers-1"><i class="fa fa-check"></i><b>3.6.2</b> Answers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="filter.html"><a href="filter.html"><i class="fa fa-check"></i><b>4</b> Filtering a dataset and refining the CO<sub>2</sub> graph</a>
<ul>
<li class="chapter" data-level="4.1" data-path="filter.html"><a href="filter.html#sequences-of-functions"><i class="fa fa-check"></i><b>4.1</b> Sequences of functions</a></li>
<li class="chapter" data-level="4.2" data-path="filter.html"><a href="filter.html#filtering-datasets-and-logical-tests"><i class="fa fa-check"></i><b>4.2</b> Filtering datasets and logical tests</a></li>
<li class="chapter" data-level="4.3" data-path="filter.html"><a href="filter.html#topStates"><i class="fa fa-check"></i><b>4.3</b> Selecting the busiest states</a></li>
<li class="chapter" data-level="4.4" data-path="filter.html"><a href="filter.html#co2-graph-for-the-top-states"><i class="fa fa-check"></i><b>4.4</b> CO<sub>2</sub> graph for the top states</a></li>
<li class="chapter" data-level="4.5" data-path="filter.html"><a href="filter.html#labelco2"><i class="fa fa-check"></i><b>4.5</b> Labelling the CO<sub>2</sub> graph</a></li>
<li class="chapter" data-level="4.6" data-path="filter.html"><a href="filter.html#what-does-the-graph-say-about-co2"><i class="fa fa-check"></i><b>4.6</b> What does the graph say about CO<sub>2</sub>?</a></li>
<li class="chapter" data-level="4.7" data-path="filter.html"><a href="filter.html#whats-gone-wrong-3"><i class="fa fa-check"></i><b>4.7</b> What’s gone wrong?</a></li>
<li class="chapter" data-level="4.8" data-path="filter.html"><a href="filter.html#exercises"><i class="fa fa-check"></i><b>4.8</b> Exercises</a>
<ul>
<li class="chapter" data-level="4.8.1" data-path="filter.html"><a href="filter.html#questions-2"><i class="fa fa-check"></i><b>4.8.1</b> Questions</a></li>
<li class="chapter" data-level="4.8.2" data-path="filter.html"><a href="filter.html#answers-2"><i class="fa fa-check"></i><b>4.8.2</b> Answers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="sortbars.html"><a href="sortbars.html"><i class="fa fa-check"></i><b>5</b> Sorting Bars, Saving Graphs, Facets</a>
<ul>
<li class="chapter" data-level="5.1" data-path="sortbars.html"><a href="sortbars.html#firstsortedbar"><i class="fa fa-check"></i><b>5.1</b> The simple sorted bar chart - more on CO<sub>2</sub></a></li>
<li class="chapter" data-level="5.2" data-path="sortbars.html"><a href="sortbars.html#saving-a-plot"><i class="fa fa-check"></i><b>5.2</b> Saving a plot</a></li>
<li class="chapter" data-level="5.3" data-path="sortbars.html"><a href="sortbars.html#plotting-more-than-one-year"><i class="fa fa-check"></i><b>5.3</b> Plotting more than one year</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="sortbars.html"><a href="sortbars.html#factors"><i class="fa fa-check"></i><b>5.3.1</b> Staggered bars, and factors</a></li>
<li class="chapter" data-level="5.3.2" data-path="sortbars.html"><a href="sortbars.html#chart-facets-more-years-in-the-bar-chart"><i class="fa fa-check"></i><b>5.3.2</b> Chart facets, more years in the bar chart</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="sortbars.html"><a href="sortbars.html#whats-gone-wrong-4"><i class="fa fa-check"></i><b>5.4</b> What’s gone wrong?</a></li>
<li class="chapter" data-level="5.5" data-path="sortbars.html"><a href="sortbars.html#exercises-1"><i class="fa fa-check"></i><b>5.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="sortbars.html"><a href="sortbars.html#questions-3"><i class="fa fa-check"></i><b>5.5.1</b> Questions</a></li>
<li class="chapter" data-level="5.5.2" data-path="sortbars.html"><a href="sortbars.html#answers-3"><i class="fa fa-check"></i><b>5.5.2</b> Answers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="extended-exercises-emissions-graphs.html"><a href="extended-exercises-emissions-graphs.html"><i class="fa fa-check"></i><b>6</b> Extended Exercises - Emissions Graphs</a>
<ul>
<li class="chapter" data-level="6.1" data-path="extended-exercises-emissions-graphs.html"><a href="extended-exercises-emissions-graphs.html#questions-4"><i class="fa fa-check"></i><b>6.1</b> Questions</a></li>
<li class="chapter" data-level="6.2" data-path="extended-exercises-emissions-graphs.html"><a href="extended-exercises-emissions-graphs.html#co2hints"><i class="fa fa-check"></i><b>6.2</b> Hints</a></li>
<li class="chapter" data-level="6.3" data-path="extended-exercises-emissions-graphs.html"><a href="extended-exercises-emissions-graphs.html#answers-4"><i class="fa fa-check"></i><b>6.3</b> Answers</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="chapter" data-level="7" data-path="loops-and-sid-data.html"><a href="loops-and-sid-data.html"><i class="fa fa-check"></i><b>7</b> Loops and SID data</a>
<ul>
<li class="chapter" data-level="7.1" data-path="loops-and-sid-data.html"><a href="loops-and-sid-data.html#vectors-and-lists"><i class="fa fa-check"></i><b>7.1</b> Vectors and Lists</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="loops-and-sid-data.html"><a href="loops-and-sid-data.html#exercises-2"><i class="fa fa-check"></i><b>7.1.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="loops-and-sid-data.html"><a href="loops-and-sid-data.html#functions-and-loops"><i class="fa fa-check"></i><b>7.2</b> Functions and Loops</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="loops-and-sid-data.html"><a href="loops-and-sid-data.html#first-function-bi-directional-airport-pairs"><i class="fa fa-check"></i><b>7.2.1</b> First function: bi-directional airport pairs</a></li>
<li class="chapter" data-level="7.2.2" data-path="loops-and-sid-data.html"><a href="loops-and-sid-data.html#looping-with-functions"><i class="fa fa-check"></i><b>7.2.2</b> Looping with functions</a></li>
<li class="chapter" data-level="7.2.3" data-path="loops-and-sid-data.html"><a href="loops-and-sid-data.html#exercises-3"><i class="fa fa-check"></i><b>7.2.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="loops-and-sid-data.html"><a href="loops-and-sid-data.html#country-data"><i class="fa fa-check"></i><b>7.3</b> Country data</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="loops-and-sid-data.html"><a href="loops-and-sid-data.html#loadonemonthly"><i class="fa fa-check"></i><b>7.3.1</b> Load one country’s monthly data</a></li>
<li class="chapter" data-level="7.3.2" data-path="loops-and-sid-data.html"><a href="loops-and-sid-data.html#loadmultiplemonthlies"><i class="fa fa-check"></i><b>7.3.2</b> Load monthly data for multiple countries</a></li>
<li class="chapter" data-level="7.3.3" data-path="loops-and-sid-data.html"><a href="loops-and-sid-data.html#load-multiple-files"><i class="fa fa-check"></i><b>7.3.3</b> Load multiple files</a></li>
<li class="chapter" data-level="7.3.4" data-path="loops-and-sid-data.html"><a href="loops-and-sid-data.html#exercises-4"><i class="fa fa-check"></i><b>7.3.4</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="splitparse.html"><a href="splitparse.html"><i class="fa fa-check"></i><b>8</b> NOTAMS: Splitting and parsing strings</a>
<ul>
<li class="chapter" data-level="8.1" data-path="splitparse.html"><a href="splitparse.html#splitting-a-column-into-many"><i class="fa fa-check"></i><b>8.1</b> Splitting a column into many</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="splitparse.html"><a href="splitparse.html#splitatcharacter"><i class="fa fa-check"></i><b>8.1.1</b> Splitting a column at a character</a></li>
<li class="chapter" data-level="8.1.2" data-path="splitparse.html"><a href="splitparse.html#splitting-a-column-at-a-regular-expression"><i class="fa fa-check"></i><b>8.1.2</b> Splitting a column at a regular expression</a></li>
<li class="chapter" data-level="8.1.3" data-path="splitparse.html"><a href="splitparse.html#splitting-a-column-at-an-either-or"><i class="fa fa-check"></i><b>8.1.3</b> Splitting a column at an either-or</a></li>
<li class="chapter" data-level="8.1.4" data-path="splitparse.html"><a href="splitparse.html#exercises-5"><i class="fa fa-check"></i><b>8.1.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="splitparse.html"><a href="splitparse.html#listcolumns"><i class="fa fa-check"></i><b>8.2</b> List columns</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="splitparse.html"><a href="splitparse.html#splitting-a-field-into-a-list"><i class="fa fa-check"></i><b>8.2.1</b> Splitting a field into a list</a></li>
<li class="chapter" data-level="8.2.2" data-path="splitparse.html"><a href="splitparse.html#more-realistic-splitting"><i class="fa fa-check"></i><b>8.2.2</b> More realistic splitting</a></li>
<li class="chapter" data-level="8.2.3" data-path="splitparse.html"><a href="splitparse.html#manipulate-fields-in-rows"><i class="fa fa-check"></i><b>8.2.3</b> Manipulate fields in rows</a></li>
<li class="chapter" data-level="8.2.4" data-path="splitparse.html"><a href="splitparse.html#exercises-6"><i class="fa fa-check"></i><b>8.2.4</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Analysing Flights with R - UNDER CONSTRUCTION</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="loops-and-sid-data" class="section level1" number="7">
<h1><span class="header-section-number">Chapter 7</span> Loops and SID data</h1>
<p>In the next few chapters we move away from tweaking code for graphs and get more hands-on with manipulating data. With another software language, this might be the time to discuss loops. In a manner of speaking we will be looping, but in a very R way. R does have a ‘for..next’ syntax, but it’s a little like the chips on the menu of an Indian restaurant: most of the time you’re better off with something else.</p>
<p>We’ll cover loops in 4 ways: 2 explicit loops, the classic R <code>lapply</code> and the tidyverse <code>map</code>-<code>reduce</code> pairing; and 2 implicit loops, because half the time in R you hardly notice you’re looping, vectors and <code>group_by</code> for looping within rows of a dataframe. <code>group_by</code> and its associated functions are a major toolset, so we will cover them in the next chapter, the other three in this one.</p>
<p>Loops go hand-in-hand with functions, so this chapter also takes some first steps in defining our own.</p>
<p>There’s a wealth of flight data to download in the <a href="https://www.eurocontrol.int/dashboard/statfor-interactive-dashboard">STATFOR Interactive Dashboard</a> or ‘SID’ to its friends. The Excel downloads look fiddly to process into something you might handle in R, but we’ll see how to do this quite quickly with a few short loops.</p>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">In this chapter, you’ll be introduced to:</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>lapply</code>, <code>rep</code>, <code>function</code>, <code>pmin</code>, <code>pmax</code>, <code>is.list</code>, <code>unlist</code>, <code>read_xlsx</code>, <code>map</code>, <code>pmap</code>, <code>crossing</code></td>
</tr>
</tbody>
</table>
<p>By the end of this chapter you will know how to write functions to extract structured, but complex data from a directory full of spreadsheets.</p>
<div id="vectors-and-lists" class="section level2" number="7.1">
<h2><span class="header-section-number">7.1</span> Vectors and Lists</h2>
<p>We met vectors in passing in Chapter <a href="start.html#start">2</a>: <code>1:50</code>. We saw other ways to construct them in section <a href="firstLook.html#someValues">3.3</a>: <code>c(1, 5, 10)</code>. But we can do more than just use them for filtering. Many functions in R are ‘vector friendly,’ in the sense that they will operate on an entire vector, and return a vector result. This can then be used in another function.</p>
<p>The use of vectors is a sort of looping through a set of values. Or if you prefer the Excel analogy, it’s like filling a column of cells with a sequence of values and then creating another with a set of formulas using those vales, but without all the repetitious clicking, dragging and filling.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="loops-and-sid-data.html#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">7</span>) <span class="sc">+</span> <span class="dv">2</span></span></code></pre></div>
<pre><code>## [1] 3 5 9</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="loops-and-sid-data.html#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span> <span class="co"># values of the second vector are recycled</span></span></code></pre></div>
<pre><code>## [1] 2 4 4 6</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="loops-and-sid-data.html#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span><span class="sc">^</span><span class="dv">2</span> <span class="co"># ^ happens before :</span></span></code></pre></div>
<pre><code>## [1] 1 2 3 4 5 6 7 8 9</code></pre>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="loops-and-sid-data.html#cb60-1" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)<span class="sc">^</span><span class="dv">2</span></span></code></pre></div>
<pre><code>## [1] 1 4 9</code></pre>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="loops-and-sid-data.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sin</span>(pi<span class="sc">/</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">3</span>)  <span class="co"># = round(sin(pi/1:4), 3)</span></span></code></pre></div>
<pre><code>## [1] 0.000 1.000 0.866 0.707</code></pre>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="loops-and-sid-data.html#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(pi, <span class="dv">0</span><span class="sc">:</span><span class="dv">4</span>) <span class="co"># vectors can work in surprising places</span></span></code></pre></div>
<pre><code>## [1] 3.0000 3.1000 3.1400 3.1420 3.1416</code></pre>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="loops-and-sid-data.html#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_c</span>(<span class="st">&quot;Year_&quot;</span>, <span class="fu">unique</span>(aviation_co2<span class="sc">$</span>YEAR))</span></code></pre></div>
<pre><code>##  [1] &quot;Year_2010&quot; &quot;Year_2011&quot; &quot;Year_2012&quot; &quot;Year_2013&quot; &quot;Year_2014&quot; &quot;Year_2015&quot; &quot;Year_2016&quot; &quot;Year_2017&quot; &quot;Year_2018&quot;
## [10] &quot;Year_2019&quot; &quot;Year_2020&quot;</code></pre>
<p>The examples illustrate that there are still some rules of precedence: <code>:</code> is evaluated after <code>^</code>, but before <code>+</code>. They also show ‘recycling’: <code>1:4</code> needs a length 4 vector to be added to it, so the values in <code>1:2</code> are recycled. Strictly speaking, this is happening with the first example (the <code>2</code> is being recycled into a vector of length 3), and also in the last example with “Year_.”</p>
<p>If the recycling can’t be done neatly, you get an error or a warning. [Evaluate <code>1:4 + 1:3</code>.]</p>
<p>There are plenty of other ways to create simple vectors when you need them.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="loops-and-sid-data.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">50</span>, <span class="at">by =</span> <span class="dv">5</span>) <span class="co"># when 10:50 won&#39;t do</span></span></code></pre></div>
<pre><code>## [1] 10 15 20 25 30 35 40 45 50</code></pre>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="loops-and-sid-data.html#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rep</span>(<span class="dv">4</span>, <span class="dv">3</span>) <span class="co"># repeat 3 times</span></span></code></pre></div>
<pre><code>## [1] 4 4 4</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="loops-and-sid-data.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">seq.Date</span>(<span class="fu">as.Date</span>(<span class="st">&quot;2020/1/15&quot;</span>), <span class="fu">as.Date</span>(<span class="st">&quot;2020/12/15&quot;</span>), <span class="at">by =</span> <span class="st">&quot;month&quot;</span>) <span class="co"># ides of 2020</span></span></code></pre></div>
<pre><code>##  [1] &quot;2020-01-15&quot; &quot;2020-02-15&quot; &quot;2020-03-15&quot; &quot;2020-04-15&quot; &quot;2020-05-15&quot; &quot;2020-06-15&quot; &quot;2020-07-15&quot; &quot;2020-08-15&quot;
##  [9] &quot;2020-09-15&quot; &quot;2020-10-15&quot; &quot;2020-11-15&quot; &quot;2020-12-15&quot;</code></pre>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="loops-and-sid-data.html#cb74-1" aria-hidden="true" tabindex="-1"></a>letters <span class="co"># &#39;letters&#39; and &#39;LETTERS&#39; are built in to base R</span></span></code></pre></div>
<pre><code>##  [1] &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot; &quot;e&quot; &quot;f&quot; &quot;g&quot; &quot;h&quot; &quot;i&quot; &quot;j&quot; &quot;k&quot; &quot;l&quot; &quot;m&quot; &quot;n&quot; &quot;o&quot; &quot;p&quot; &quot;q&quot; &quot;r&quot; &quot;s&quot; &quot;t&quot; &quot;u&quot; &quot;v&quot; &quot;w&quot; &quot;x&quot; &quot;y&quot; &quot;z&quot;</code></pre>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="loops-and-sid-data.html#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># and by combining others</span></span>
<span id="cb76-2"><a href="loops-and-sid-data.html#cb76-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb76-3"><a href="loops-and-sid-data.html#cb76-3" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">8</span>, <span class="dv">13</span>)</span>
<span id="cb76-4"><a href="loops-and-sid-data.html#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(a, b)</span></code></pre></div>
<pre><code>## [1]  1  1  2  3  5  8 13</code></pre>
<p>While vectors and vector-savvy functions are, in a sense, loops with an R flavour, it’s probably better to think of them as working ‘in parallel’ calculated all at the same time, rather than one by one as they would be in a ‘for…next’ loop. (TBD)</p>
<p>Every element in a vector must be the same type (character, numeric, and here we introduce <code>integer</code> with an <code>L</code> after it, standing for ‘long’). If you need something more general than that, then <code>list</code> is for you. A ‘list’ can contain almost anything, including vectors and other lists.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="loops-and-sid-data.html#cb78-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">787</span>, <span class="st">&quot;neo&quot;</span>, <span class="dv">320</span>)</span>
<span id="cb78-2"><a href="loops-and-sid-data.html#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(a) <span class="co"># every element was silently converted to character</span></span></code></pre></div>
<pre><code>##  chr [1:3] &quot;787&quot; &quot;neo&quot; &quot;320&quot;</code></pre>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="loops-and-sid-data.html#cb80-1" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">72</span>, <span class="st">&quot;CO2&quot;</span>, 380L, <span class="fu">c</span>(<span class="st">&quot;Embraer&quot;</span>, <span class="st">&quot;ATR&quot;</span>))</span>
<span id="cb80-2"><a href="loops-and-sid-data.html#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(b) <span class="co"># list is less fussy</span></span></code></pre></div>
<pre><code>## List of 4
##  $ : num 72
##  $ : chr &quot;CO2&quot;
##  $ : int 380
##  $ : chr [1:2] &quot;Embraer&quot; &quot;ATR&quot;</code></pre>
<p>We already saw how to extract specific elements of a vector, in section <a href="firstLook.html#someValues">3.3</a>. [How would you extract the first and third elements of vector <code>a</code>? Does the same work for the list <code>b</code>?]</p>
<p>R has some more tricks up its sleeve to help with referring to elements. They can all have names. Or some can have names, and some not, as in the following examples. To extract elements by their names you can use the square brackets: so within the brackets you can give names or numbers. Lists have an extra trick, the <code>$</code>.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="loops-and-sid-data.html#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># putting brackets around the code prints the result as well as executing it</span></span>
<span id="cb82-2"><a href="loops-and-sid-data.html#cb82-2" aria-hidden="true" tabindex="-1"></a>(a <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">a =</span> <span class="dv">7</span>, <span class="dv">3</span>, <span class="at">b =</span> <span class="dv">7</span>, <span class="at">c =</span> <span class="dv">800</span>))</span></code></pre></div>
<pre><code>##   a       b   c 
##   7   3   7 800</code></pre>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="loops-and-sid-data.html#cb84-1" aria-hidden="true" tabindex="-1"></a>(b <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">pi =</span> <span class="fl">3.14</span>, <span class="at">pie =</span> <span class="st">&quot;apple&quot;</span>, <span class="at">pier =</span> <span class="st">&quot;Bournemouth&quot;</span>, <span class="at">piers =</span> <span class="fu">c</span>(<span class="st">&quot;Weston&quot;</span>, <span class="st">&quot;Wigan&quot;</span>)))</span></code></pre></div>
<pre><code>## $pi
## [1] 3.14
## 
## $pie
## [1] &quot;apple&quot;
## 
## $pier
## [1] &quot;Bournemouth&quot;
## 
## $piers
## [1] &quot;Weston&quot; &quot;Wigan&quot;</code></pre>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="loops-and-sid-data.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(b)</span></code></pre></div>
<pre><code>## [1] &quot;pi&quot;    &quot;pie&quot;   &quot;pier&quot;  &quot;piers&quot;</code></pre>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="loops-and-sid-data.html#cb88-1" aria-hidden="true" tabindex="-1"></a>a[<span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>)]</span></code></pre></div>
<pre><code>## a b 
## 7 7</code></pre>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="loops-and-sid-data.html#cb90-1" aria-hidden="true" tabindex="-1"></a>b[<span class="st">&quot;pie&quot;</span>]</span></code></pre></div>
<pre><code>## $pie
## [1] &quot;apple&quot;</code></pre>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="loops-and-sid-data.html#cb92-1" aria-hidden="true" tabindex="-1"></a>b<span class="sc">$</span>pier</span></code></pre></div>
<pre><code>## [1] &quot;Bournemouth&quot;</code></pre>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="loops-and-sid-data.html#cb94-1" aria-hidden="true" tabindex="-1"></a>b<span class="sc">$</span>pier[<span class="dv">2</span>]</span></code></pre></div>
<pre><code>## [1] NA</code></pre>
<p>Does the <code>$</code> method work for vectors? [Try <code>a$c</code>] It’s no coincidence that we use <code>$</code> to extract an element from a list, as well as (in section <a href="firstLook.html#extractfield">3.2</a>) extracting a field from a dataset, but I’ll leave you to wonder why that is.</p>
<div id="exercises-2" class="section level3" number="7.1.1">
<h3><span class="header-section-number">7.1.1</span> Exercises</h3>
<div id="questions-5" class="section level4" number="7.1.1.1">
<h4><span class="header-section-number">7.1.1.1</span> Questions</h4>
<ol style="list-style-type: decimal">
<li>What code generates the vector <code>2 6 10 14</code>?</li>
<li>What code generates the vector <code>1 2 1 2 1 2 1 2</code>?</li>
<li>What code generates the vector <code>"A1" "B2" "C3" "D4" "E5"</code>?</li>
<li>What code generates the vector <code>1.000 0.500 0.333 0.250 0.200</code>?</li>
<li>What code generates the vector <code>"1/1" "1/2" "1/3" "1/4" "1/5"</code>?</li>
<li>Create a named vector containing the numbers 1 to 26 named with upper case letters of the alphabet (and not by typing them out!).</li>
</ol>
</div>
<div id="answers-5" class="section level4" number="7.1.1.2">
<h4><span class="header-section-number">7.1.1.2</span> Answers</h4>
<p>For the first 5 there are several answers that work. The ones here are relatively compact.</p>
<ol style="list-style-type: decimal">
<li><code>seq(2, 14, by = 4)</code> (or <code>c(2, 6, 10, 14)</code> is hardly any longer)</li>
<li><code>rep(1:2, 4)</code></li>
<li><code>str_c(LETTERS[1:5], 1:5)</code></li>
<li><code>1/1:5</code></li>
<li><code>str_c("1/", 1:5)</code></li>
<li>The <code>names</code> function can be used to set as well as to get the names.</li>
</ol>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="loops-and-sid-data.html#cb96-1" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">26</span></span>
<span id="cb96-2"><a href="loops-and-sid-data.html#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(z) <span class="ot">&lt;-</span> LETTERS </span></code></pre></div>
</div>
</div>
</div>
<div id="functions-and-loops" class="section level2" number="7.2">
<h2><span class="header-section-number">7.2</span> Functions and Loops</h2>
<p>We have already seen plenty of example of using functions, passing parameters and returning their values. How do we define our own functions?</p>
<p>We said that almost everything you do with R is use functions. Well, you even define a function using <code>function()</code>, which is a special sort of function: <code>my_function &lt;- function(parameters) { code to apply to the parameters }</code>. The parameters are all of the form <code>name</code> or <code>name=expression</code> if you want to give a default value. The value returned is the result of the last phrase of code, or what is explicitly in a <code>return()</code> statement.</p>
<div id="first-function-bi-directional-airport-pairs" class="section level3" number="7.2.1">
<h3><span class="header-section-number">7.2.1</span> First function: bi-directional airport pairs</h3>
<p>For our first function, think about converting uni-directional flight data to bi-directional: you want to merge <code>Heathrow&gt;JFK</code> with <code>JFK&gt;Heathrow</code>. Often we do this by just taking the alphabetically-first one first. Our first function is to help that.</p>
<p>In this first example we hit the ground running, introducing an optional but powerful parameter. You can use an ellipsis, <code>...</code>, in the parameter list of your function; then echo it in a function <em>within</em> your function. Then a user can pass, in the function call, parameters directly to the inner function call. We use it here to allow us to pass the <code>sep=</code> parameter (or others) to the <code>str_c</code> function.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="loops-and-sid-data.html#cb97-1" aria-hidden="true" tabindex="-1"></a>alpha_str_c <span class="ot">&lt;-</span> <span class="cf">function</span>(n1, n2, ...) {</span>
<span id="cb97-2"><a href="loops-and-sid-data.html#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># concatenate in parallel each element of these two vectors</span></span>
<span id="cb97-3"><a href="loops-and-sid-data.html#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># but with the smaller of the two elements first.</span></span>
<span id="cb97-4"><a href="loops-and-sid-data.html#cb97-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_c</span>(<span class="fu">pmin</span>(n1, n2), <span class="fu">pmax</span>(n1, n2), ...)</span>
<span id="cb97-5"><a href="loops-and-sid-data.html#cb97-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb97-6"><a href="loops-and-sid-data.html#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="co">#some airports</span></span>
<span id="cb97-7"><a href="loops-and-sid-data.html#cb97-7" aria-hidden="true" tabindex="-1"></a>ap_list1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;EGLL&quot;</span>, <span class="st">&quot;KJFK&quot;</span>, <span class="st">&quot;LFPG&quot;</span>)</span>
<span id="cb97-8"><a href="loops-and-sid-data.html#cb97-8" aria-hidden="true" tabindex="-1"></a>ap_list2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;KJFK&quot;</span>, <span class="st">&quot;EGLL&quot;</span>, <span class="st">&quot;LEMD&quot;</span>)</span>
<span id="cb97-9"><a href="loops-and-sid-data.html#cb97-9" aria-hidden="true" tabindex="-1"></a><span class="fu">alpha_str_c</span>(ap_list1, ap_list2, <span class="at">sep =</span> <span class="st">&quot;&lt;&gt;&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;EGLL&lt;&gt;KJFK&quot; &quot;EGLL&lt;&gt;KJFK&quot; &quot;LEMD&lt;&gt;LFPG&quot;</code></pre>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="loops-and-sid-data.html#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># it recycles values if the vectors are different lengths</span></span>
<span id="cb99-2"><a href="loops-and-sid-data.html#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="co"># this is inherited directly from the two functions that it calls</span></span>
<span id="cb99-3"><a href="loops-and-sid-data.html#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="fu">alpha_str_c</span>(<span class="st">&quot;EHAM&quot;</span>, ap_list2, <span class="at">sep =</span> <span class="st">&quot;&lt;&gt;&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;EHAM&lt;&gt;KJFK&quot; &quot;EGLL&lt;&gt;EHAM&quot; &quot;EHAM&lt;&gt;LEMD&quot;</code></pre>
<p>This is a pretty simple function. It doesn’t even define any of its own data, just calls another function. We could have assigned the result to a variable <code>pairs &lt;-</code> or something like that. The result would be no different, and the variable is forgotten once you leave the function anyway. [Try this.]</p>
<p>Using <code>...</code> in this way saves you the bother of deciding how and which parameters to pass on to the <code>str_c</code>, and can open your function to being used in ways you had not first intended.</p>
<p>Even a short function like this is worth writing. Once you’ve checked it, you can use it several times and be confident there are no typos (it would be easy to type <code>pmin</code> twice, for example). Note the way the lines are broken in the function definition. R really doesn’t mind, but they’re easier to read if they’re all formatted in the same way.</p>
<p>The <a href="https://style.tidyverse.org/functions.html">tidyverse style guide</a> says that function names should be verbs. In the spirit of this, our ‘alphabetize and concatenate’ function name becomes <code>alpha_str_c</code>, shortening “concatenate” for obvious reasons. We could have dropped the <code>str_</code> bit, but it’s a reminder of which parameters can be passed with <code>...</code>.</p>
<p>The style guide means that, if you’re trying to remember a tidyverse function, in theory the mental search space can be cut down to verbs. In practice, English doesn’t help much since so many words are both nouns and verbs, as crossword-setters exploit with glee.</p>
<p>What if we sometimes want to combine in reverse alphabetical order? Rather than have a separate function, we extend <code>alpha_str_c</code> using a logical <code>TRUE</code> or <code>FALSE</code> parameter, and an <code>if</code>-<code>else</code> statement. The relevant help section here is <code>if</code> for the language construct, rather than for the function <code>dplyr::if_else</code> (which you saw in section <a href="filter.html#labelco2">4.5</a>).</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="loops-and-sid-data.html#cb101-1" aria-hidden="true" tabindex="-1"></a>alpha_str_c <span class="ot">&lt;-</span> <span class="cf">function</span>(n1, n2, <span class="at">asc =</span> <span class="cn">TRUE</span>, ...) {</span>
<span id="cb101-2"><a href="loops-and-sid-data.html#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># concatenate in parallel each element of these two vectors</span></span>
<span id="cb101-3"><a href="loops-and-sid-data.html#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># but with the smaller of the two elements first.</span></span>
<span id="cb101-4"><a href="loops-and-sid-data.html#cb101-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (asc) {</span>
<span id="cb101-5"><a href="loops-and-sid-data.html#cb101-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_c</span>(<span class="fu">pmin</span>(n1, n2), <span class="fu">pmax</span>(n1, n2), ...)</span>
<span id="cb101-6"><a href="loops-and-sid-data.html#cb101-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb101-7"><a href="loops-and-sid-data.html#cb101-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_c</span>(<span class="fu">pmax</span>(n1, n2), <span class="fu">pmin</span>(n1, n2), ...)</span>
<span id="cb101-8"><a href="loops-and-sid-data.html#cb101-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-9"><a href="loops-and-sid-data.html#cb101-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb101-10"><a href="loops-and-sid-data.html#cb101-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-11"><a href="loops-and-sid-data.html#cb101-11" aria-hidden="true" tabindex="-1"></a><span class="co">#some airports</span></span>
<span id="cb101-12"><a href="loops-and-sid-data.html#cb101-12" aria-hidden="true" tabindex="-1"></a>ap_list1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;EGLL&quot;</span>, <span class="st">&quot;KJFK&quot;</span>, <span class="st">&quot;LFPG&quot;</span>)</span>
<span id="cb101-13"><a href="loops-and-sid-data.html#cb101-13" aria-hidden="true" tabindex="-1"></a><span class="fu">alpha_str_c</span>(<span class="st">&quot;EFHK&quot;</span>, ap_list1, <span class="at">sep =</span> <span class="st">&quot;&lt;&gt;&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;EFHK&lt;&gt;EGLL&quot; &quot;EFHK&lt;&gt;KJFK&quot; &quot;EFHK&lt;&gt;LFPG&quot;</code></pre>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="loops-and-sid-data.html#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">alpha_str_c</span>(<span class="st">&quot;EFHK&quot;</span>, ap_list1, <span class="at">sep =</span> <span class="st">&quot;&lt;&gt;&quot;</span>, <span class="at">asc =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## [1] &quot;EGLL&lt;&gt;EFHK&quot; &quot;KJFK&lt;&gt;EFHK&quot; &quot;LFPG&lt;&gt;EFHK&quot;</code></pre>
<p>That’s quite a lot of curly brackets for one if-else. In fact, when all you have within them is a single statement, you can omit the “{}.” [Exercise: Remove the excess brackets and show the result is unchanged.]</p>
<p>The example also illustrates that, once you’re passing a parameter “by name,” the order doesn’t matter: <code>asc</code> appears before <code>...</code> and hence before <code>sep</code> in the parameter list, but we pass them in any order we like.</p>
<p>When <em>using</em> a function, passing parameters by position is more compact. Your variable names should make clear what is in them, anyway. So it should be clear what you’re passing to the function, here two airport lists. What the function calls them internally is irrelevant.</p>
<p>However, when passing a logical parameter as in the last example, it isn’t at all clear what the parameter means from your call to the function, without opening the function. <code>alpha_str_c("EFHK", ap_list1, FALSE, sep = "&lt;&gt;")</code> uses the implicit position of the <code>asc</code> parameter and gives the same result. [Try this.] But when you come back to the code in a week or two, will you remember what the <code>FALSE</code> means? Better then, to be explicit with the parameter name, as we were in the code chunk above.</p>
</div>
<div id="looping-with-functions" class="section level3" number="7.2.2">
<h3><span class="header-section-number">7.2.2</span> Looping with functions</h3>
<p>Now that we can define functions, we can try out a basic R loop. There are many variants to the ‘apply a function over a list of values’ function <code>lapply</code> [read the help file]. Each gives different sorts of result, and they can be difficult to remember. As a result, I use <code>lapply</code> probably more often than I should, and just deal with the fact that it returns a list each time.</p>
<p>One variety of function doesn’t get a name (<code>function_name &lt;-</code>) at all. These anonymous, temporary functions are defined just to be passed as parameters to another function, and are forgotten afterwards. Here, we pass anonymous functions to <code>lapply</code>, which takes a list and applies a function to the list one at a time, returning a list of results.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="loops-and-sid-data.html#cb105-1" aria-hidden="true" tabindex="-1"></a>listed_loop <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="cf">function</span>(x) {x<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> x})</span>
<span id="cb105-2"><a href="loops-and-sid-data.html#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="fu">is.list</span>(listed_loop)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="loops-and-sid-data.html#cb107-1" aria-hidden="true" tabindex="-1"></a>unlisted_loop <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="cf">function</span>(x) {x<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> x}) <span class="sc">%&gt;%</span> </span>
<span id="cb107-2"><a href="loops-and-sid-data.html#cb107-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlist</span>()</span>
<span id="cb107-3"><a href="loops-and-sid-data.html#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="co"># which could also have been listed_loop %&gt;% unlist()</span></span>
<span id="cb107-4"><a href="loops-and-sid-data.html#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="fu">is.list</span>(unlisted_loop)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="loops-and-sid-data.html#cb109-1" aria-hidden="true" tabindex="-1"></a>unlisted_loop</span></code></pre></div>
<pre><code>##  [1]   2   6  12  20  30  42  56  72  90 110</code></pre>
<p>Check in the Environment pane, or by printing to the console, how these are different. [Why is <code>unlisted_loop</code> in a different part of the Environment pane?] Which of the two you need will depend on what you’re developing, but I think the second is more frequent.</p>
<p>For a second example, we wrap this <code>lapply</code>-<code>unlist</code> pairing up inside a function. Before you run this code chunk, or read on to the end, describe in words what it will do, given two vectors of text. The answer is a couple of paragraphs earlier.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="loops-and-sid-data.html#cb111-1" aria-hidden="true" tabindex="-1"></a>combos_str_c <span class="ot">&lt;-</span> <span class="cf">function</span>(s1, s2, ...){</span>
<span id="cb111-2"><a href="loops-and-sid-data.html#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(s1, <span class="cf">function</span>(x) <span class="fu">str_c</span>(x, s2, ...)) <span class="sc">%&gt;%</span> </span>
<span id="cb111-3"><a href="loops-and-sid-data.html#cb111-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>()</span>
<span id="cb111-4"><a href="loops-and-sid-data.html#cb111-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb111-5"><a href="loops-and-sid-data.html#cb111-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-6"><a href="loops-and-sid-data.html#cb111-6" aria-hidden="true" tabindex="-1"></a><span class="fu">combos_str_c</span>(<span class="fu">c</span>(<span class="st">&quot;A319&quot;</span>, <span class="st">&quot;A320&quot;</span>, <span class="st">&quot;A321&quot;</span>), <span class="fu">c</span>(<span class="st">&quot;ceo&quot;</span>, <span class="st">&quot;neo&quot;</span>), <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;A319ceo&quot; &quot;A319neo&quot; &quot;A320ceo&quot; &quot;A320neo&quot; &quot;A321ceo&quot; &quot;A321neo&quot;</code></pre>
<p>‘Combos’ is short for ‘combinations.’ Rather than just pasting elements of the vectors in pairs, as in <code>alpha_str_c</code>, it creates all combinations of the two. In the example this creates a list of ‘current engine’ and ‘new engine’ options of Airbus aircraft. You’ll have to check elsewhere if all 6 exist!</p>
</div>
<div id="exercises-3" class="section level3" number="7.2.3">
<h3><span class="header-section-number">7.2.3</span> Exercises</h3>
<div id="questions-6" class="section level4" number="7.2.3.1">
<h4><span class="header-section-number">7.2.3.1</span> Questions</h4>
<ol style="list-style-type: decimal">
<li>What would happen if you used <code>min</code> and <code>max</code> instead, in <code>alpha_str_c</code>? Read the help file first to decide. Then check this by adapting the code.</li>
<li>What happens if you pass lists with respectively 3 and 4 airport codes in them? Why does it happen twice?</li>
<li>What other parameters can you pass to <code>alpha_str_c</code>?</li>
<li>Inside <code>alpha_str_c</code> assign the result to a variable. Does anything change?</li>
<li>How would you adapt <code>alpha_str_c</code> to use <code>&lt;&gt;</code> as a default separator?</li>
<li>With this new version, do the two examples of its use, in the code chunks above, still work? How can you make the examples even more compact?</li>
<li>Building on <code>combos_str_c</code> write a function to create all bidirectional combinations of two lists of airport names or codes, eg <code>c("EGLL", "LEMD", "LFPG", "LTFM")</code> and <code>c("LIRF", "EHAM", "LFPO", "EDDF")</code>?</li>
<li>Extend the function from (7) to find all possible routes between the airports in a single list. (Hint: It means adding just 5 characters to the code, including spaces.)</li>
<li>Add a parameter to allow this function to return, either the full list or with duplicates removed. (Hint: You’ll need a function you saw in section <a href="firstLook.html#extractfield">3.2</a>)</li>
</ol>
</div>
<div id="answers-6" class="section level4" number="7.2.3.2">
<h4><span class="header-section-number">7.2.3.2</span> Answers</h4>
<ol style="list-style-type: decimal">
<li><code>min</code> combines whatever it is passed, and takes the minimum of them all. So you get the first airport of all, and the last. I have used <code>min</code> instead of <code>pmin</code> more times than I’d like to say. Think “parallel min need pmin.”</li>
<li>R will ‘recycle’ elements to match the lengths of the vectors, but in this case, warn you that that is happening. It’s the <code>pmin</code> and <code>pmax</code> that are doing the recycling, not the <code>str_c</code>, so the error is found twice.</li>
<li>From the help file, <code>str_c</code> and therefore <code>alpha_str_c</code> also accepts <code>collapse</code>. [Experiment with using the <code>collapse</code> parameter.]</li>
<li><code>alpha_str_c &lt;- function(n1, n2, ...) {pairs &lt;- str_c(pmin(n1, n2), pmax(n1, n2), ...)}</code> and no, no difference. The function returns the last thing calculated.</li>
<li><code>alpha_str_c &lt;- function(n1, n2, sep="&lt;&gt;", ...) {str_c(pmin(n1, n2), pmax(n1, n2), sep = sep, ...)}</code> You need to define the default in your own function, and now pass it explicitly to the new one. I don’t really like <code>sep = sep</code> which feels an odd thing to write, but it would be stranger still to have a separator parameter than was called something else.</li>
<li>Yes they do, but now <code>alpha_str_c("EHAM", ap_list2)</code> is enough.</li>
<li>This merges the two functions we saw earlier. The <code>asc</code> and <code>sep</code> parameters both work through the ellipsis <code>...</code> even though they’re from different functions: this demonstrates the power of ‘nested’ ellipsis.</li>
</ol>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="loops-and-sid-data.html#cb113-1" aria-hidden="true" tabindex="-1"></a>alpha_combos_str_c <span class="ot">&lt;-</span> <span class="cf">function</span>(s1, s2, ...){</span>
<span id="cb113-2"><a href="loops-and-sid-data.html#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(s1, <span class="cf">function</span>(x) <span class="fu">alpha_str_c</span>(x, s2, ...)) <span class="sc">%&gt;%</span> </span>
<span id="cb113-3"><a href="loops-and-sid-data.html#cb113-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>()</span>
<span id="cb113-4"><a href="loops-and-sid-data.html#cb113-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb113-5"><a href="loops-and-sid-data.html#cb113-5" aria-hidden="true" tabindex="-1"></a>ap_list1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;EGLL&quot;</span>, <span class="st">&quot;LEMD&quot;</span>, <span class="st">&quot;LFPG&quot;</span>, <span class="st">&quot;LTFM&quot;</span>)</span>
<span id="cb113-6"><a href="loops-and-sid-data.html#cb113-6" aria-hidden="true" tabindex="-1"></a>ap_list2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;LIRF&quot;</span>, <span class="st">&quot;EHAM&quot;</span>, <span class="st">&quot;LFPO&quot;</span>, <span class="st">&quot;EDDF&quot;</span>)</span>
<span id="cb113-7"><a href="loops-and-sid-data.html#cb113-7" aria-hidden="true" tabindex="-1"></a><span class="fu">alpha_combos_str_c</span>(ap_list1, ap_list2, <span class="at">sep =</span> <span class="st">&quot;&lt;&gt;&quot;</span>)</span></code></pre></div>
<pre><code>##  [1] &quot;EGLL&lt;&gt;LIRF&quot; &quot;EGLL&lt;&gt;EHAM&quot; &quot;EGLL&lt;&gt;LFPO&quot; &quot;EDDF&lt;&gt;EGLL&quot; &quot;LEMD&lt;&gt;LIRF&quot; &quot;EHAM&lt;&gt;LEMD&quot; &quot;LEMD&lt;&gt;LFPO&quot; &quot;EDDF&lt;&gt;LEMD&quot;
##  [9] &quot;LFPG&lt;&gt;LIRF&quot; &quot;EHAM&lt;&gt;LFPG&quot; &quot;LFPG&lt;&gt;LFPO&quot; &quot;EDDF&lt;&gt;LFPG&quot; &quot;LIRF&lt;&gt;LTFM&quot; &quot;EHAM&lt;&gt;LTFM&quot; &quot;LFPO&lt;&gt;LTFM&quot; &quot;EDDF&lt;&gt;LTFM&quot;</code></pre>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="loops-and-sid-data.html#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">alpha_combos_str_c</span>(ap_list1, ap_list2, <span class="at">sep =</span> <span class="st">&quot;&lt;&gt;&quot;</span>, <span class="at">asc =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>##  [1] &quot;LIRF&lt;&gt;EGLL&quot; &quot;EHAM&lt;&gt;EGLL&quot; &quot;LFPO&lt;&gt;EGLL&quot; &quot;EGLL&lt;&gt;EDDF&quot; &quot;LIRF&lt;&gt;LEMD&quot; &quot;LEMD&lt;&gt;EHAM&quot; &quot;LFPO&lt;&gt;LEMD&quot; &quot;LEMD&lt;&gt;EDDF&quot;
##  [9] &quot;LIRF&lt;&gt;LFPG&quot; &quot;LFPG&lt;&gt;EHAM&quot; &quot;LFPO&lt;&gt;LFPG&quot; &quot;LFPG&lt;&gt;EDDF&quot; &quot;LTFM&lt;&gt;LIRF&quot; &quot;LTFM&lt;&gt;EHAM&quot; &quot;LTFM&lt;&gt;LFPO&quot; &quot;LTFM&lt;&gt;EDDF&quot;</code></pre>
<ol start="8" style="list-style-type: decimal">
<li>We just want the second list to be the same as the first one, by default, so like this.</li>
</ol>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="loops-and-sid-data.html#cb117-1" aria-hidden="true" tabindex="-1"></a>alpha_combos_str_c <span class="ot">&lt;-</span> <span class="cf">function</span>(s1, <span class="at">s2 =</span> s1, ...){</span>
<span id="cb117-2"><a href="loops-and-sid-data.html#cb117-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(s1, <span class="cf">function</span>(x) <span class="fu">alpha_str_c</span>(x, s2, ...)) <span class="sc">%&gt;%</span> </span>
<span id="cb117-3"><a href="loops-and-sid-data.html#cb117-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>()</span>
<span id="cb117-4"><a href="loops-and-sid-data.html#cb117-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb117-5"><a href="loops-and-sid-data.html#cb117-5" aria-hidden="true" tabindex="-1"></a>ap_list1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;EGLL&quot;</span>, <span class="st">&quot;LEMD&quot;</span>, <span class="st">&quot;LFPG&quot;</span>, <span class="st">&quot;LTFM&quot;</span>)</span>
<span id="cb117-6"><a href="loops-and-sid-data.html#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="fu">alpha_combos_str_c</span>(ap_list1, <span class="at">sep =</span> <span class="st">&quot;&lt;&gt;&quot;</span>)</span></code></pre></div>
<pre><code>##  [1] &quot;EGLL&lt;&gt;EGLL&quot; &quot;EGLL&lt;&gt;LEMD&quot; &quot;EGLL&lt;&gt;LFPG&quot; &quot;EGLL&lt;&gt;LTFM&quot; &quot;EGLL&lt;&gt;LEMD&quot; &quot;LEMD&lt;&gt;LEMD&quot; &quot;LEMD&lt;&gt;LFPG&quot; &quot;LEMD&lt;&gt;LTFM&quot;
##  [9] &quot;EGLL&lt;&gt;LFPG&quot; &quot;LEMD&lt;&gt;LFPG&quot; &quot;LFPG&lt;&gt;LFPG&quot; &quot;LFPG&lt;&gt;LTFM&quot; &quot;EGLL&lt;&gt;LTFM&quot; &quot;LEMD&lt;&gt;LTFM&quot; &quot;LFPG&lt;&gt;LTFM&quot; &quot;LTFM&lt;&gt;LTFM&quot;</code></pre>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="loops-and-sid-data.html#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">alpha_combos_str_c</span>(ap_list1, <span class="at">sep =</span> <span class="st">&quot;&lt;&gt;&quot;</span>, <span class="at">asc =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>##  [1] &quot;EGLL&lt;&gt;EGLL&quot; &quot;LEMD&lt;&gt;EGLL&quot; &quot;LFPG&lt;&gt;EGLL&quot; &quot;LTFM&lt;&gt;EGLL&quot; &quot;LEMD&lt;&gt;EGLL&quot; &quot;LEMD&lt;&gt;LEMD&quot; &quot;LFPG&lt;&gt;LEMD&quot; &quot;LTFM&lt;&gt;LEMD&quot;
##  [9] &quot;LFPG&lt;&gt;EGLL&quot; &quot;LFPG&lt;&gt;LEMD&quot; &quot;LFPG&lt;&gt;LFPG&quot; &quot;LTFM&lt;&gt;LFPG&quot; &quot;LTFM&lt;&gt;EGLL&quot; &quot;LTFM&lt;&gt;LEMD&quot; &quot;LTFM&lt;&gt;LFPG&quot; &quot;LTFM&lt;&gt;LTFM&quot;</code></pre>
<ol start="9" style="list-style-type: decimal">
<li>This calls for a logical parameter, and finally a good use for defining a variable within the function. The final <code>else pairs</code> is really saying <code>else return(pairs)</code>. If you omit the <code>else pairs</code> completely then, when <code>uniq=FALSE</code> the <code>if</code> evaluates to nothing, so the function returns nothing. [Try this.]</li>
</ol>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="loops-and-sid-data.html#cb121-1" aria-hidden="true" tabindex="-1"></a>alpha_combos_str_c <span class="ot">&lt;-</span> <span class="cf">function</span>(s1, <span class="at">s2=</span>s1, <span class="at">uniq =</span> <span class="cn">FALSE</span>, ...){</span>
<span id="cb121-2"><a href="loops-and-sid-data.html#cb121-2" aria-hidden="true" tabindex="-1"></a>  pairs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(s1, <span class="cf">function</span>(x) <span class="fu">alpha_str_c</span>(x, s2, ...)) <span class="sc">%&gt;%</span> </span>
<span id="cb121-3"><a href="loops-and-sid-data.html#cb121-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>()</span>
<span id="cb121-4"><a href="loops-and-sid-data.html#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (uniq) <span class="fu">unique</span>(pairs)</span>
<span id="cb121-5"><a href="loops-and-sid-data.html#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> pairs</span>
<span id="cb121-6"><a href="loops-and-sid-data.html#cb121-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-7"><a href="loops-and-sid-data.html#cb121-7" aria-hidden="true" tabindex="-1"></a>ap_list1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;EGLL&quot;</span>, <span class="st">&quot;LEMD&quot;</span>, <span class="st">&quot;LFPG&quot;</span>, <span class="st">&quot;LTFM&quot;</span>)</span>
<span id="cb121-8"><a href="loops-and-sid-data.html#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="fu">alpha_combos_str_c</span>(ap_list1, <span class="at">sep =</span> <span class="st">&quot;&lt;&gt;&quot;</span>)</span></code></pre></div>
<pre><code>##  [1] &quot;EGLL&lt;&gt;EGLL&quot; &quot;EGLL&lt;&gt;LEMD&quot; &quot;EGLL&lt;&gt;LFPG&quot; &quot;EGLL&lt;&gt;LTFM&quot; &quot;EGLL&lt;&gt;LEMD&quot; &quot;LEMD&lt;&gt;LEMD&quot; &quot;LEMD&lt;&gt;LFPG&quot; &quot;LEMD&lt;&gt;LTFM&quot;
##  [9] &quot;EGLL&lt;&gt;LFPG&quot; &quot;LEMD&lt;&gt;LFPG&quot; &quot;LFPG&lt;&gt;LFPG&quot; &quot;LFPG&lt;&gt;LTFM&quot; &quot;EGLL&lt;&gt;LTFM&quot; &quot;LEMD&lt;&gt;LTFM&quot; &quot;LFPG&lt;&gt;LTFM&quot; &quot;LTFM&lt;&gt;LTFM&quot;</code></pre>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="loops-and-sid-data.html#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">alpha_combos_str_c</span>(ap_list1, <span class="at">sep =</span> <span class="st">&quot;&lt;&gt;&quot;</span>, <span class="at">uniq =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>##  [1] &quot;EGLL&lt;&gt;EGLL&quot; &quot;EGLL&lt;&gt;LEMD&quot; &quot;EGLL&lt;&gt;LFPG&quot; &quot;EGLL&lt;&gt;LTFM&quot; &quot;LEMD&lt;&gt;LEMD&quot; &quot;LEMD&lt;&gt;LFPG&quot; &quot;LEMD&lt;&gt;LTFM&quot; &quot;LFPG&lt;&gt;LFPG&quot;
##  [9] &quot;LFPG&lt;&gt;LTFM&quot; &quot;LTFM&lt;&gt;LTFM&quot;</code></pre>
</div>
<div id="extended-question" class="section level4" number="7.2.3.3">
<h4><span class="header-section-number">7.2.3.3</span> Extended question</h4>
<p>Some theory you didn’t want to know.</p>
<p>A default value provided in a function definition is often called a ‘promise.’ It is only evaluated at the moment that it is needed, not at, say, some hypothetical moment of compilation. Knowing that, predict the result of calling <code>promises()</code>, without specifying any parameters. Then try it in the console.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="loops-and-sid-data.html#cb125-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb125-2"><a href="loops-and-sid-data.html#cb125-2" aria-hidden="true" tabindex="-1"></a>promises <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">a =</span> <span class="dv">1</span>, <span class="at">b =</span> a<span class="sc">^</span><span class="dv">2</span>) {</span>
<span id="cb125-3"><a href="loops-and-sid-data.html#cb125-3" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb125-4"><a href="loops-and-sid-data.html#cb125-4" aria-hidden="true" tabindex="-1"></a>  b <span class="co">#short for return(b)</span></span>
<span id="cb125-5"><a href="loops-and-sid-data.html#cb125-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
</div>
<div id="country-data" class="section level2" number="7.3">
<h2><span class="header-section-number">7.3</span> Country data</h2>
<p>The first data that we look at from <a href="https://www.eurocontrol.int/dashboard/statfor-interactive-dashboard">SID</a> is the ‘monthlies.’ This tab in the dashboard shows monthly total flights in a choice of airspaces, for any period from Jan 2005. You can ask for one or more market segments, too, so low-cost, or business aviation etc. And the units can be switched to flight minutes rather than flights. Data can be exported to Excel format.</p>
<div class="figure">
<img src="images/SID_Monthly.png" alt="" />
<p class="caption">Monthly data in the SID</p>
</div>
<div id="loadonemonthly" class="section level3" number="7.3.1">
<h3><span class="header-section-number">7.3.1</span> Load one country’s monthly data</h3>
<p>An ‘airspace’ here is usually a country’s airspace: think of extending the border on the ground upwards. In some cases, such as Belgium and Luxembourg, they share an airspace. In others an airspace is split: Spain has (continental) Spain and Canary Islands. There are also aggregates, such as ECAC, for which you’ll find details on line, for example <a href="https://www.eurocontrol.int/publication/eurocontrol-five-year-forecast-2020-2024">region definitions</a>. Being airspaces, they have overflights: flights which neither depart, nor land in the country but just pass through the airspace.</p>
<p>There are two little catches to the SID data. Firstly, the Excel export comes in a number of tables one after the other on a single worksheet. Secondly, the field names of each table are horrible, and use merged cells.</p>
<p>We’ve extracted some data for the all-cargo market segment. As a first example, we extract a single table from within the Excel file. [Download some yourself and inspect the Excel file.]</p>
<p><img src="images/SID_monthly_excel_snapshot.png" alt="The Excel download is in ‘tables’ like this." />
The column names are month, and three values for each of arrival, departure, (one airport in the airspace and one not), internal (both airports in), overflight (neither) and total. We use <code>combos_str_c</code> to generate some more useful column names.</p>
<p>Loading one table is then just a matter of saying how many rows to ignore at the top (<code>skip=</code>) and how many rows to load (<code>n_max</code>).</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="loops-and-sid-data.html#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this adds the output of combos_str_c to a vector that already has &#39;month&#39; in it</span></span>
<span id="cb126-2"><a href="loops-and-sid-data.html#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the indentation should help highlight that</span></span>
<span id="cb126-3"><a href="loops-and-sid-data.html#cb126-3" aria-hidden="true" tabindex="-1"></a>monthly_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;month&quot;</span>, </span>
<span id="cb126-4"><a href="loops-and-sid-data.html#cb126-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">combos_str_c</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;D&quot;</span>, <span class="st">&quot;I&quot;</span>, <span class="st">&quot;O&quot;</span>, <span class="st">&quot;T&quot;</span>), </span>
<span id="cb126-5"><a href="loops-and-sid-data.html#cb126-5" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">c</span>(<span class="st">&quot;_last&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;_growth&quot;</span>),</span>
<span id="cb126-6"><a href="loops-and-sid-data.html#cb126-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sep=</span><span class="st">&quot;&quot;</span>))</span>
<span id="cb126-7"><a href="loops-and-sid-data.html#cb126-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-8"><a href="loops-and-sid-data.html#cb126-8" aria-hidden="true" tabindex="-1"></a>monthlies <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="st">&quot;data/SID_Monthly_AllCargo.xlsx&quot;</span>, <span class="at">skip =</span> <span class="dv">9</span>, <span class="at">n_max =</span> <span class="dv">14</span>, </span>
<span id="cb126-9"><a href="loops-and-sid-data.html#cb126-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">col_names =</span> monthly_cols) </span></code></pre></div>
<p>The <code>month</code> column has been correctly interpreted as a date. We’ll look at dates and date-time variables in more detail in section TBD. For the moment, if you see <code>POSIXct</code> then this is a format for date-time variables. In this chapter, the dates look after themselves.</p>
</div>
<div id="loadmultiplemonthlies" class="section level3" number="7.3.2">
<h3><span class="header-section-number">7.3.2</span> Load monthly data for multiple countries</h3>
<p>That didn’t take much code. If we want to load multiple countries, then we need to wrap up the extraction into a function. At the same time, we can pick up some metadata: market segment and units from the top of the file, and the airspace name from just before the data. These are obtained by selecting a specific range (here just one cell at a time).</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="loops-and-sid-data.html#cb127-1" aria-hidden="true" tabindex="-1"></a>extract_monthlies <span class="ot">&lt;-</span> <span class="cf">function</span>(file, skip, n_rows){</span>
<span id="cb127-2"><a href="loops-and-sid-data.html#cb127-2" aria-hidden="true" tabindex="-1"></a>  monthly_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;month&quot;</span>, </span>
<span id="cb127-3"><a href="loops-and-sid-data.html#cb127-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">combos_str_c</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;D&quot;</span>, <span class="st">&quot;I&quot;</span>, <span class="st">&quot;O&quot;</span>, <span class="st">&quot;T&quot;</span>), </span>
<span id="cb127-4"><a href="loops-and-sid-data.html#cb127-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">c</span>(<span class="st">&quot;_last&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;_growth&quot;</span>),</span>
<span id="cb127-5"><a href="loops-and-sid-data.html#cb127-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">sep=</span><span class="st">&quot;&quot;</span>))</span>
<span id="cb127-6"><a href="loops-and-sid-data.html#cb127-6" aria-hidden="true" tabindex="-1"></a>  meta_segment <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(file, <span class="at">range =</span> <span class="st">&quot;A2&quot;</span>, </span>
<span id="cb127-7"><a href="loops-and-sid-data.html#cb127-7" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">col_names =</span> <span class="st">&quot;segment&quot;</span>) </span>
<span id="cb127-8"><a href="loops-and-sid-data.html#cb127-8" aria-hidden="true" tabindex="-1"></a>  meta_units <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(file, <span class="at">range =</span> <span class="st">&quot;A4&quot;</span>, </span>
<span id="cb127-9"><a href="loops-and-sid-data.html#cb127-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">col_names =</span> <span class="st">&quot;units&quot;</span>)</span>
<span id="cb127-10"><a href="loops-and-sid-data.html#cb127-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># need to create an Excel reference &quot;An&quot; where n is just before skip</span></span>
<span id="cb127-11"><a href="loops-and-sid-data.html#cb127-11" aria-hidden="true" tabindex="-1"></a>  meta_airspace <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(file, <span class="at">range =</span> <span class="fu">str_c</span>(<span class="st">&quot;A&quot;</span>, skip <span class="sc">-</span> <span class="dv">2</span>), </span>
<span id="cb127-12"><a href="loops-and-sid-data.html#cb127-12" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">col_names =</span> <span class="st">&quot;airspace&quot;</span>)</span>
<span id="cb127-13"><a href="loops-and-sid-data.html#cb127-13" aria-hidden="true" tabindex="-1"></a>  monthlies <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(file, <span class="at">skip =</span> skip, <span class="at">n_max =</span> n_rows, </span>
<span id="cb127-14"><a href="loops-and-sid-data.html#cb127-14" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">col_names =</span> monthly_cols) </span>
<span id="cb127-15"><a href="loops-and-sid-data.html#cb127-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this is a quick way to return a dataframe reasonable column order</span></span>
<span id="cb127-16"><a href="loops-and-sid-data.html#cb127-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the first 3 get recycled as usual, to the same length as monthlies</span></span>
<span id="cb127-17"><a href="loops-and-sid-data.html#cb127-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(meta_airspace, meta_segment, meta_units, monthlies)</span>
<span id="cb127-18"><a href="loops-and-sid-data.html#cb127-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb127-19"><a href="loops-and-sid-data.html#cb127-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-20"><a href="loops-and-sid-data.html#cb127-20" aria-hidden="true" tabindex="-1"></a><span class="co"># check this works, as before but with added metadata</span></span>
<span id="cb127-21"><a href="loops-and-sid-data.html#cb127-21" aria-hidden="true" tabindex="-1"></a>monthlies <span class="ot">&lt;-</span> <span class="fu">extract_monthlies</span>(<span class="st">&quot;data/SID_Monthly_AllCargo.xlsx&quot;</span>, <span class="at">skip =</span> <span class="dv">9</span>, <span class="at">n_rows =</span> <span class="dv">14</span>)</span></code></pre></div>
<p>By inspecting the Excel file, we need skips <code>c(9, 28, 47, ..., 199)</code>. [How do you generate that with <code>seq</code>?]</p>
<p>For the looping we are spoiled for choice.</p>
<ul>
<li>We could use <code>lapply</code>, as we saw earlier. That is simple to remember. The anonymous function isn’t pretty, but that’s hardly grounds for dismissal.</li>
<li>We can use <code>purrr::map</code> which is very similar, and has a nicer format for anonymous functions. It also reminds us that there’s a wide variety of <code>map</code> functions around. Something for most purposes.</li>
<li><code>pmap</code> is one of the <code>purrr::map</code> family. It has the nice property of enabling us to specify a set of locations for the data, then very compactly extract from those locations: implicitly taking a field <code>file</code> from the <code>extract_locs</code> dataframe and passing it to the <code>file</code> parameter of a function. And similarly for the other parameters. Remember it as “parameter or parallel map? pmap.”</li>
</ul>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="loops-and-sid-data.html#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># V1. Use lapply</span></span>
<span id="cb128-2"><a href="loops-and-sid-data.html#cb128-2" aria-hidden="true" tabindex="-1"></a>all_monthlies_v1 <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq</span>(<span class="dv">9</span>, <span class="dv">199</span>, <span class="at">by =</span> <span class="dv">19</span>),</span>
<span id="cb128-3"><a href="loops-and-sid-data.html#cb128-3" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">function</span>(x) <span class="fu">extract_monthlies</span>(<span class="st">&quot;data/SID_Monthly_AllCargo.xlsx&quot;</span>,</span>
<span id="cb128-4"><a href="loops-and-sid-data.html#cb128-4" aria-hidden="true" tabindex="-1"></a>                                                   x, <span class="dv">14</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb128-5"><a href="loops-and-sid-data.html#cb128-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span>
<span id="cb128-6"><a href="loops-and-sid-data.html#cb128-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-7"><a href="loops-and-sid-data.html#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="co"># V2. With &#39;map&#39; the anonymous function is more compact</span></span>
<span id="cb128-8"><a href="loops-and-sid-data.html#cb128-8" aria-hidden="true" tabindex="-1"></a>all_monthlies_v2 <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">seq</span>(<span class="dv">9</span>, <span class="dv">199</span>, <span class="at">by =</span> <span class="dv">19</span>),</span>
<span id="cb128-9"><a href="loops-and-sid-data.html#cb128-9" aria-hidden="true" tabindex="-1"></a>                     <span class="sc">~</span><span class="fu">extract_monthlies</span>(<span class="st">&quot;data/SID_Monthly_AllCargo.xlsx&quot;</span>, ., <span class="dv">14</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb128-10"><a href="loops-and-sid-data.html#cb128-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span>
<span id="cb128-11"><a href="loops-and-sid-data.html#cb128-11" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(all_monthlies_v1, all_monthlies_v2)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="loops-and-sid-data.html#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># V3.</span></span>
<span id="cb130-2"><a href="loops-and-sid-data.html#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build a set of parameters for the extract</span></span>
<span id="cb130-3"><a href="loops-and-sid-data.html#cb130-3" aria-hidden="true" tabindex="-1"></a>extract_locs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">file =</span> <span class="st">&quot;data/SID_Monthly_AllCargo.xlsx&quot;</span>,</span>
<span id="cb130-4"><a href="loops-and-sid-data.html#cb130-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">skip =</span> <span class="fu">seq</span>(<span class="dv">9</span>, <span class="dv">199</span>, <span class="at">by =</span> <span class="dv">19</span>),</span>
<span id="cb130-5"><a href="loops-and-sid-data.html#cb130-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">n_rows =</span> <span class="dv">14</span>)</span>
<span id="cb130-6"><a href="loops-and-sid-data.html#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Then pmap passes them by name to your function</span></span>
<span id="cb130-7"><a href="loops-and-sid-data.html#cb130-7" aria-hidden="true" tabindex="-1"></a>all_monthlies_v3 <span class="ot">&lt;-</span> extract_locs <span class="sc">%&gt;%</span> </span>
<span id="cb130-8"><a href="loops-and-sid-data.html#cb130-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmap</span>(extract_monthlies) <span class="sc">%&gt;%</span> </span>
<span id="cb130-9"><a href="loops-and-sid-data.html#cb130-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span>
<span id="cb130-10"><a href="loops-and-sid-data.html#cb130-10" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(all_monthlies_v1, all_monthlies_v3)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Code that keeps data (or metadata, like filenames) in datasets rather than in parameter lists, is an advantage: it will be easier to extend to other files (as we will see TBD); and it means that you can also save it and hence keep a record. None of the solutions is ‘wrong,’ but the third one is the one I prefer.</p>
</div>
<div id="load-multiple-files" class="section level3" number="7.3.3">
<h3><span class="header-section-number">7.3.3</span> Load multiple files</h3>
<p>The third version is most interesting because we actually want to load data from multiple files. For this book, there’s an admin step first, which is to get them from the web onto your machine. We do this with a list and a function that does the looping for us.</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="loops-and-sid-data.html#cb132-1" aria-hidden="true" tabindex="-1"></a>file_segments <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;LowCost&quot;</span>, <span class="st">&quot;TradSched&quot;</span>, <span class="st">&quot;BusAvn&quot;</span>, <span class="st">&quot;AllCargo&quot;</span>)</span>
<span id="cb132-2"><a href="loops-and-sid-data.html#cb132-2" aria-hidden="true" tabindex="-1"></a>urls <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">&quot;https://github.com/david6marsh/flights_in_R/raw/main/data/SID_Monthly_&quot;</span>,</span>
<span id="cb132-3"><a href="loops-and-sid-data.html#cb132-3" aria-hidden="true" tabindex="-1"></a>                file_segments, </span>
<span id="cb132-4"><a href="loops-and-sid-data.html#cb132-4" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;.xlsx&quot;</span>)</span>
<span id="cb132-5"><a href="loops-and-sid-data.html#cb132-5" aria-hidden="true" tabindex="-1"></a>local_names <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">&quot;data/SID_Monthly_&quot;</span>, file_segments, <span class="st">&quot;.xlsx&quot;</span>)</span>
<span id="cb132-6"><a href="loops-and-sid-data.html#cb132-6" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(urls, local_names, <span class="at">mode =</span> <span class="st">&quot;wb&quot;</span>) </span></code></pre></div>
<p>In this particular case, we already know the file names. More often, we have downloaded a number of files, and know the file name format, but want to avoid typing in the names ourselves. The <code>dir</code> function does the job for us, and matches to a pattern. Best to check the number of files, or check the list by eye just to see that the pattern didn’t find files that you don’t want to process.</p>
<p>We need something like the code for <code>extract_locs</code>, but automatic “recycling” does not work here. We will use <code>tidyr::crossing</code> for making what’s sometimes called a Cartesian join of all combinations of file name and skip (with n_rows along for the ride).</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="loops-and-sid-data.html#cb133-1" aria-hidden="true" tabindex="-1"></a>SID_files <span class="ot">&lt;-</span> <span class="fu">dir</span>(<span class="st">&quot;data&quot;</span>, <span class="at">pattern =</span> <span class="st">&quot;SID_Monthly&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-2"><a href="loops-and-sid-data.html#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="co"># force all combinations of file and skip</span></span>
<span id="cb133-3"><a href="loops-and-sid-data.html#cb133-3" aria-hidden="true" tabindex="-1"></a>extract_locs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">file =</span> SID_files) <span class="sc">%&gt;%</span> </span>
<span id="cb133-4"><a href="loops-and-sid-data.html#cb133-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossing</span>(<span class="fu">data.frame</span>(<span class="at">skip =</span> <span class="fu">seq</span>(<span class="dv">9</span>, <span class="dv">199</span>, <span class="at">by =</span> <span class="dv">19</span>),</span>
<span id="cb133-5"><a href="loops-and-sid-data.html#cb133-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">n_rows =</span> <span class="dv">14</span>))</span>
<span id="cb133-6"><a href="loops-and-sid-data.html#cb133-6" aria-hidden="true" tabindex="-1"></a><span class="co"># and load</span></span>
<span id="cb133-7"><a href="loops-and-sid-data.html#cb133-7" aria-hidden="true" tabindex="-1"></a>many_segment_monthlies <span class="ot">&lt;-</span> extract_locs <span class="sc">%&gt;%</span> </span>
<span id="cb133-8"><a href="loops-and-sid-data.html#cb133-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmap</span>(extract_monthlies) <span class="sc">%&gt;%</span> </span>
<span id="cb133-9"><a href="loops-and-sid-data.html#cb133-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span></code></pre></div>
<p>It might take a minute to load the files, but it didn’t take much code.</p>
<p>There’s a lot more that we can do with such data: tidying, summarising, adapting, plotting. But for that we need <code>group_by</code>, which is the main theme of the next chapter. In the meantime, save the file to <code>data/</code> rather than rely on your project to keep a track of it. (We covered <code>save</code> at the end of section <a href="firstLook.html#loadco2">3.1</a>.)</p>
</div>
<div id="exercises-4" class="section level3" number="7.3.4">
<h3><span class="header-section-number">7.3.4</span> Exercises</h3>
<div id="questions-7" class="section level4" number="7.3.4.1">
<h4><span class="header-section-number">7.3.4.1</span> Questions</h4>
<p>1 Use <code>lapply</code> and an anonymous (temporary) function to loop over the <code>skips</code>. What happens if you <code>unlist</code> the result?
2) Use <code>read_xlsx</code> to load the A-column from the file. Use seq to generate the row position of the airspace names (rather than the starts of the data). Hence extract the airspace names.
3) Is the <code>monthlies</code> dataset tidy?
4) Plot total flights with one line per airspace.
5) How would you improve this graph?
6) Where is the drop in flights resulting from the COVID-19 lockdowns?
7) Try a single <code>data.frame</code> without the <code>crossing</code>. Why does R complain?
8) As for question 4, but facet by market segment.
10) From the SID, download a longer set of data, for multiple market segments. Adapt the code you have used to import this. Plot the data, for a quick visual check.
11) Adapt <code>extract_monthlies</code> to allow the user to modify the column names. Advanced version: Use the <code>...</code> when doing this, but why might this be risky?
12) What sanity checking of column names would be useful?</p>
</div>
<div id="answers-7" class="section level4" number="7.3.4.2">
<h4><span class="header-section-number">7.3.4.2</span> Answers</h4>
<ol style="list-style-type: decimal">
<li>It seems to work, but you get a list of answers. <code>Unlist</code> just puts everything into a single vector, all structure is lost. There are ways to save this (eg <code>bind_rows(monthlies)</code> is how to bind this list of results together row-wise), but even then, we lose track of which file the data have come from. this leads towards an approach that becomes increasingly like a construction from Heath-Robinson (or Panamarenko, if you prefer).</li>
</ol>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="loops-and-sid-data.html#cb134-1" aria-hidden="true" tabindex="-1"></a>skips <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">9</span>, <span class="dv">199</span>, <span class="at">by =</span> <span class="dv">19</span>)</span>
<span id="cb134-2"><a href="loops-and-sid-data.html#cb134-2" aria-hidden="true" tabindex="-1"></a>monthlies <span class="ot">&lt;-</span> <span class="fu">lapply</span>(skips,</span>
<span id="cb134-3"><a href="loops-and-sid-data.html#cb134-3" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">function</span>(x) readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="st">&quot;data/SID_Monthly_AllCargo.xlsx&quot;</span>, </span>
<span id="cb134-4"><a href="loops-and-sid-data.html#cb134-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">skip =</span> x, <span class="at">n_max =</span> <span class="dv">14</span>, </span>
<span id="cb134-5"><a href="loops-and-sid-data.html#cb134-5" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">col_names =</span> monthly_cols))</span>
<span id="cb134-6"><a href="loops-and-sid-data.html#cb134-6" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">unlist</span>(monthlies)</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Code like this. I followed through the links in the help file to find the <code>cell_cols</code> syntax, but you could also just use something like <code>"A1:A200"</code>, knowing that you only need the first 197 anyway, and <code>read_xlsx</code> drops blank rows from the end.</li>
</ol>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="loops-and-sid-data.html#cb135-1" aria-hidden="true" tabindex="-1"></a>name_rows <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">7</span>, <span class="dv">197</span>, <span class="at">by =</span> <span class="dv">19</span>)</span>
<span id="cb135-2"><a href="loops-and-sid-data.html#cb135-2" aria-hidden="true" tabindex="-1"></a>airspace_names <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="st">&quot;data/SID_Monthly_AllCargo.xlsx&quot;</span>, </span>
<span id="cb135-3"><a href="loops-and-sid-data.html#cb135-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">range =</span> cellranger<span class="sc">::</span><span class="fu">cell_cols</span>(<span class="st">&quot;A&quot;</span>), </span>
<span id="cb135-4"><a href="loops-and-sid-data.html#cb135-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">col_names =</span> <span class="st">&quot;airspace&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb135-5"><a href="loops-and-sid-data.html#cb135-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(name_rows)</span></code></pre></div>
<p>You could also use <code>[]</code> syntax instead of <code>slice</code>. Can you give two alternative approaches to this? Even if it has only 1 column, <code>airspace_names</code> is a dataframe, so you need to refer to both the column and the rows.</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="loops-and-sid-data.html#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># two approaches</span></span>
<span id="cb136-2"><a href="loops-and-sid-data.html#cb136-2" aria-hidden="true" tabindex="-1"></a>airspace_names <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="st">&quot;data/SID_Monthly_AllCargo.xlsx&quot;</span>, </span>
<span id="cb136-3"><a href="loops-and-sid-data.html#cb136-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">range =</span> cellranger<span class="sc">::</span><span class="fu">cell_cols</span>(<span class="st">&quot;A&quot;</span>), </span>
<span id="cb136-4"><a href="loops-and-sid-data.html#cb136-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">col_names =</span> <span class="st">&quot;airspace&quot;</span>) </span>
<span id="cb136-5"><a href="loops-and-sid-data.html#cb136-5" aria-hidden="true" tabindex="-1"></a>v1 <span class="ot">&lt;-</span> airspace_names<span class="sc">$</span>airspace[name_rows]</span>
<span id="cb136-6"><a href="loops-and-sid-data.html#cb136-6" aria-hidden="true" tabindex="-1"></a>v2 <span class="ot">&lt;-</span> airspace_names[name_rows, <span class="dv">1</span>]</span>
<span id="cb136-7"><a href="loops-and-sid-data.html#cb136-7" aria-hidden="true" tabindex="-1"></a><span class="co"># and a third - pull out the vector - in effect does the same as the &#39;$&#39; in 1.</span></span>
<span id="cb136-8"><a href="loops-and-sid-data.html#cb136-8" aria-hidden="true" tabindex="-1"></a>v3 <span class="ot">&lt;-</span> airspace_names <span class="sc">%&gt;%</span> <span class="fu">pull</span>(airspace)</span>
<span id="cb136-9"><a href="loops-and-sid-data.html#cb136-9" aria-hidden="true" tabindex="-1"></a>v3 <span class="ot">&lt;-</span> v3[name_rows]</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>No, not tidy, because we have multiple columns of flight data.</li>
<li>A minimum graph is something like this.</li>
</ol>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="loops-and-sid-data.html#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all_monthlies_v3,</span>
<span id="cb137-2"><a href="loops-and-sid-data.html#cb137-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(month, T, <span class="at">colour =</span> airspace)) <span class="sc">+</span> </span>
<span id="cb137-3"><a href="loops-and-sid-data.html#cb137-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb137-4"><a href="loops-and-sid-data.html#cb137-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;Total flights in month&quot;</span>)</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-61-1.png" width="672" /></p>
<ol start="5" style="list-style-type: decimal">
<li>There are rather too many colours. Perhaps split into large and smaller groups and facet. Or one facet per airspace. <code>ggplot</code> formats the month axis nicely: probably labelling this as “month” is unnecessary, so remove it.</li>
<li>Without the context of 2019, the drop in traffic is not evident. But in fact, this is the all-cargo market segment which was relatively unaffected by COVID-19, or at least did not see the deep declines in flights of other market segments.</li>
<li>Because it’s not obvious how to recycle vectors of length 4, 19 and 1 to get the same lengths.</li>
<li>A minimum graph is something like this. Three further experiments: free up the y-axis, between the four facets; transform <code>T</code> into thousands (as we did for millions in previous examples); remove ECAC, as it is quite dominant.</li>
</ol>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="loops-and-sid-data.html#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(many_segment_monthlies,</span>
<span id="cb138-2"><a href="loops-and-sid-data.html#cb138-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(month, T, <span class="at">colour =</span> airspace)) <span class="sc">+</span> </span>
<span id="cb138-3"><a href="loops-and-sid-data.html#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb138-4"><a href="loops-and-sid-data.html#cb138-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># facet_wrap(~ segment, scales = &quot;free_y&quot;) +</span></span>
<span id="cb138-5"><a href="loops-and-sid-data.html#cb138-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;Total flights in month&quot;</span>)</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-62-1.png" width="672" />
10) If you save the downloaded Excel files into the <code>data</code> directory then you’ll need to name them so that you can tell them apart from the first batch. Easier might be to use a subdirectory of <code>data</code>. Otherwise, just adapt <code>skip</code> and <code>n_max</code>.
11) We do the full monty and make all three parts adaptable. It’s polite, to yourself and others, when adding parameters to an existing function, to make the default behaviour exactly as it was before. That way, any existing uses of the function will continue to work. List new parameters after the old ones, and supply default values to give the original behaviour.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="loops-and-sid-data.html#cb139-1" aria-hidden="true" tabindex="-1"></a>extract_monthlies <span class="ot">&lt;-</span> <span class="cf">function</span>(file, skip, n_rows,</span>
<span id="cb139-2"><a href="loops-and-sid-data.html#cb139-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">col1 =</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;D&quot;</span>, <span class="st">&quot;I&quot;</span>, <span class="st">&quot;O&quot;</span>, <span class="st">&quot;T&quot;</span>),</span>
<span id="cb139-3"><a href="loops-and-sid-data.html#cb139-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">col2 =</span> <span class="fu">c</span>(<span class="st">&quot;_last&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;_growth&quot;</span>),</span>
<span id="cb139-4"><a href="loops-and-sid-data.html#cb139-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">sep =</span> <span class="st">&quot;&quot;</span>){</span>
<span id="cb139-5"><a href="loops-and-sid-data.html#cb139-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(col1) <span class="sc">==</span> <span class="dv">5</span>)</span>
<span id="cb139-6"><a href="loops-and-sid-data.html#cb139-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(col2) <span class="sc">==</span> <span class="dv">3</span>)</span>
<span id="cb139-7"><a href="loops-and-sid-data.html#cb139-7" aria-hidden="true" tabindex="-1"></a>  monthly_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;month&quot;</span>, </span>
<span id="cb139-8"><a href="loops-and-sid-data.html#cb139-8" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">combos_str_c</span>(col1, col2, <span class="at">sep =</span> sep))</span>
<span id="cb139-9"><a href="loops-and-sid-data.html#cb139-9" aria-hidden="true" tabindex="-1"></a>  meta_segment <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(file, <span class="at">range =</span> <span class="st">&quot;A2&quot;</span>, </span>
<span id="cb139-10"><a href="loops-and-sid-data.html#cb139-10" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">col_names =</span> <span class="st">&quot;segment&quot;</span>) </span>
<span id="cb139-11"><a href="loops-and-sid-data.html#cb139-11" aria-hidden="true" tabindex="-1"></a>  meta_units <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(file, <span class="at">range =</span> <span class="st">&quot;A4&quot;</span>, </span>
<span id="cb139-12"><a href="loops-and-sid-data.html#cb139-12" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">col_names =</span> <span class="st">&quot;units&quot;</span>)</span>
<span id="cb139-13"><a href="loops-and-sid-data.html#cb139-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># need to create an Excel reference &quot;An&quot; where n is just before skip</span></span>
<span id="cb139-14"><a href="loops-and-sid-data.html#cb139-14" aria-hidden="true" tabindex="-1"></a>  meta_airspace <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(file, <span class="at">range =</span> <span class="fu">str_c</span>(<span class="st">&quot;A&quot;</span>, skip <span class="sc">-</span> <span class="dv">2</span>), </span>
<span id="cb139-15"><a href="loops-and-sid-data.html#cb139-15" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">col_names =</span> <span class="st">&quot;airspace&quot;</span>)</span>
<span id="cb139-16"><a href="loops-and-sid-data.html#cb139-16" aria-hidden="true" tabindex="-1"></a>  monthlies <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(file, <span class="at">skip =</span> skip, <span class="at">n_max =</span> n_rows, </span>
<span id="cb139-17"><a href="loops-and-sid-data.html#cb139-17" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">col_names =</span> monthly_cols) </span>
<span id="cb139-18"><a href="loops-and-sid-data.html#cb139-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this is a quick way to return a dataframe reasonable column order</span></span>
<span id="cb139-19"><a href="loops-and-sid-data.html#cb139-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the first 3 get recycled as usual, to the same length as monthlies</span></span>
<span id="cb139-20"><a href="loops-and-sid-data.html#cb139-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(meta_airspace, meta_segment, meta_units, monthlies)</span>
<span id="cb139-21"><a href="loops-and-sid-data.html#cb139-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb139-22"><a href="loops-and-sid-data.html#cb139-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-23"><a href="loops-and-sid-data.html#cb139-23" aria-hidden="true" tabindex="-1"></a>monthlies <span class="ot">&lt;-</span> <span class="fu">extract_monthlies</span>(<span class="st">&quot;data/SID_Monthly_AllCargo.xlsx&quot;</span>, <span class="at">skip =</span> <span class="dv">9</span>, <span class="at">n_rows =</span> <span class="dv">14</span>,</span>
<span id="cb139-24"><a href="loops-and-sid-data.html#cb139-24" aria-hidden="true" tabindex="-1"></a>                               <span class="at">col1 =</span> <span class="fu">c</span>(<span class="st">&quot;Arr&quot;</span>, <span class="st">&quot;Dep&quot;</span>, <span class="st">&quot;Int&quot;</span>, <span class="st">&quot;Over&quot;</span>, <span class="st">&quot;Total&quot;</span>))</span></code></pre></div>
<p>For the ‘advanced’ version, the clue is if you find yourself writing <code>sep = sep</code> to pass parameters on to another function. Here we replace both <code>sep = ""</code> and <code>sep = sep</code> with <code>...</code>. There is a risk with this that a user could then also pass the <code>collapse</code> parameter, which would have unfortunate consequences. So safer is not to use the <code>...</code> here.
12) It’s important that <code>col1</code> has 5 values, and <code>col2</code> has 3 values, otherwise the column naming will be scrambled. How do you get the number of values in a vector? With that, we also need the function <code>stopifnot</code> for checking parameters. Here we would add two lines, eg <code>stopifnot(length(col1) == 5)</code>, <code>stopifnot(length(col2) == 3)</code> at the start of the function. Try this. We use two lines because then the error reporting is more precise: it tells the user exactly which parameter is the wrong length.</p>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="references.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="splitparse.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["flights_in_R.pdf", "flights_in_R.epub"],
"toc": {
"collapse": "subsection"
},
"theme": "sepia"
});
});
</script>

</body>

</html>
